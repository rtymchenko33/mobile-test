name: Mobile App Tests

on:
  schedule:
    - cron: '0 6 * * *'
  workflow_dispatch:

jobs:
  run-tests:
    runs-on: windows-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Set up Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci

      - name: Set up Android SDK
        run: |
          choco install -y android-sdk
          echo "ANDROID_HOME=C:\tools\android-sdk" >> $env:GITHUB_ENV
          echo "PATH=$env:PATH;C:\tools\android-sdk\platform-tools;C:\tools\android-sdk\emulator" >> $env:GITHUB_ENV

      - name: Create emulator
        run: |
          sdkmanager "system-images;android-33;google_apis;x86_64"
          echo no | avdmanager create avd -n test -k "system-images;android-33;google_apis;x86_64" --force
          start "" emulator -avd test -no-window -no-audio &
          timeout /t 120

      - name: Start Appium server
        run: |
          npm install -g appium
          start /b appium --port 4723 --log-level info

      - name: Run WDIO tests
        run: npx wdio run wdio.conf.js
